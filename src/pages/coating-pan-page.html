<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../elements/text-input.html">
<link rel="import" href="../elements/number-unit-input.html">
<link rel="import" href="../elements/coating-pan-graphic.html">
<link rel="import" href="../redux-mixin.html">
<link rel="import" href="../my-icons.html">
<link rel="import" href="shared-page-styles.html">

<dom-module id="coating-pan-page">
  <template>
    <style include='shared-page-styles'>
      .graphic-container {
        display: flex;
        justify-content: space-around;
      }
      .pan-graphic {
        height: 256px;
        width: 256px;
        fill: var(--text-secondary-color);
        fill-opacity: 0.4;
        stroke: var(--text-primary-color);
        stroke-width: 0.25px;
        stroke-linejoin: round;
      }
      .pan-fill {
        fill: var(--app-primary-color);
      }
    </style>
    
    <firebase-auth id="auth" user="{{user}}"></firebase-auth>
    <firebase-query id='panQuery' path='/pans/[[user.uid]]'></firebase-query>
    
    <div id='header-container'>
      <div id='header-card'>
        <div id='header-subhead'>Equipment</div>
        <div id='header-title'>Coating Pan</div>
        <div id='header-text'>
          The coating pan dashboard provies insight into the coating pan you are using. 
        	With a few measurements of the coating pan you can learn more about different pan volumes, pan fill and pan speeds.
        	Or you can choose a coating pan from the library.
        </div>
      </div>
    </div>
    
    <div class='warning-chip' hidden='[[!isOverfilled(maxFillVolume, fillVolume)]]'>
      <iron-icon icon='my-icons:warning'></iron-icon>
      <div class='warning-text'>
        Batch Volume exceed maximum working volume. Considering lower batch size or choosing a bigger coating pan.
      </div>
    </div>
    
    <div id='main-container'>
      
      <div id='left-column'>
        
        <div class='card'>
          <div class='card-title'>Coating Pan Outline</div>
          <div class='graphic-container'>
            
            <coating-pan-graphic
              front-view
              pan-diameter='[[panDiameter]]'
              opening-diameter='[[openingDiameter]]'
              wall-width='[[wallWidth]]'
              brim-width='[[brimWidth]]'
              fill-height='[[fillHeight]]'
              fill-width='[[fillWidth]]'
              fill-length='[[fillLength]]'>
            </coating-pan-graphic>
            
            <coating-pan-graphic
              side-view
              pan-diameter='[[panDiameter]]'
              opening-diameter='[[openingDiameter]]'
              wall-width='[[wallWidth]]'
              brim-width='[[brimWidth]]'
              fill-height='[[fillHeight]]'
              fill-width='[[fillWidth]]'
              fill-length='[[fillLength]]'>
            </coating-pan-graphic>
            
          </div>
        </div>
          
        <div class='card'>
          <div class='card-title'>Inputs</div>
          <number-unit-input 
    	    	title='Main Diameter' 
    	    	value='[[panDiameter]]' 
    	    	type='length'
    	    	selected-units='{{lengthUnits}}'
    	    	details='The main diameter of the coating pan'
    	    	on-value-changed='panDiameterChanged'>
    	    </number-unit-input>
    	    <number-unit-input 
    	    	title='Opening' 
    	    	value='[[openingDiameter]]' 
    	    	type='length'
    	    	details='The diameter of the pan opening'
    	    	selected-units='{{lengthUnits}}'
    	    	on-value-changed='openingDiameterChanged'>
    	    </number-unit-input>
    	    <number-unit-input 
    	    	title='Depth at Brim' 
    	    	value='[[brimWidth]]' 
    	    	type='length'
    	    	selected-units='{{lengthUnits}}'
    	    	details='The depth from the front brim to the back'
    	    	on-value-changed='brimWidthChanged'>
    	    </number-unit-input>
    	    <number-unit-input 
    	    	title='Pan Wall Depth' 
    	    	value='[[wallWidth]]' 
    	    	type='length'
    	    	details='The depth of the coating pan along the perforated pan wall'
    	    	selected-units='{{lengthUnits}}'
    	    	on-value-changed='wallWidthChanged'>
    	    </number-unit-input>
        </div>
        
        <div class='card'>
            <div class='card-title'>Estimated Volumes</div>
            <number-unit-input
              title='Brim Volume'
              details='The capacity of the pan to the brim'
              no-input 
              decimals='1' 
              value='[[brimVolume]]' 
              type='volume' 
              selected-units='{{volumeUnits}}'>
            </number-unit-input>
            <number-unit-input
              title='Max Working Volume'
              details='The capacity of the pan upto 1" from the brim'
              no-input 
              decimals='1' 
              value='[[maxFillVolume]]' 
              type='volume' 
              selected-units='{{volumeUnits}}'>
            </number-unit-input>
            <number-unit-input
              title='Min Working Volume'
              details='The capacity of the pan to be 60% full of brim height'
              no-input 
              decimals='1' 
              value='[[minFillVolume]]' 
              type='volume' 
              selected-units='{{volumeUnits}}'>
            </number-unit-input>
          </div>
          
     <!--   <div class='card'>-->
     <!--     <div class='card-title'>Pan Fill Calculations</div>-->
					<!--<number-unit-input-->
					<!--  no-input-->
     <!-- 	  	title='Fill Height' -->
    	<!--		  value='[[fillHeight]]' -->
    	<!--		  type='length' -->
    	<!--		  selected-units='{{lengthUnits}}'-->
    	<!--		  details='The maximum bed height'>-->
    	<!--		</number-unit-input>-->
    	<!--		<number-unit-input-->
					<!--  no-input-->
     <!-- 	  	title='Fill to Brim' -->
    	<!--		  value='[[fillToBrim]]' -->
    	<!--		  type='length' -->
    	<!--		  selected-units='{{lengthUnits}}'-->
    	<!--		  details='The distance between the product bed and the brim opening'>-->
    	<!--		</number-unit-input>-->
    	<!--	<number-unit-input-->
					<!--  no-input-->
     <!-- 	  	title='Fill Width' -->
    	<!--		  value='[[fillWidth]]' -->
    	<!--		  type='length' -->
    	<!--		  selected-units='{{lengthUnits}}'-->
    	<!--		  details='The maximum width of the product bed on the surface'>-->
    	<!--		</number-unit-input>-->
     <!--   </div>-->
        
      </div>
      
      <div class='right-column'>
        <div class='highlight-card'>
          <div class='card-title'>Coating Pan Library</div>
          <div class='card-text'>The library includes a list of coating pans with predefined measurements. The library is based on coating pans found 
          at different Colocon sites and coating pan vendor specfications. Choose one today to get started.
          </div>
          <paper-button class='highlight-button'on-tap='gotoLibrary'>Library</paper-button>
        </div>
        
        <div class='card'>
          <div class='card-title'>Information</div>
          <text-input title='Vendor' value='[[vendorName]]' on-value-changed='vendorNameChanged'></text-input>
          <text-input title='Equipment' value='[[equipmentName]]' on-value-changed='equipmentNameChanged'></text-input>
          <text-input title='Nickname' value='[[nickname]]' on-value-changed='nicknameChanged'></text-input>
          <text-input title='Company' value='[[companyName]]' on-value-changed='companyNameChanged'></text-input>
          <text-input title='Location' value='[[locationName]]' on-value-changed='locationNameChanged'></text-input>
        </div>
        
        <div class='highlight-card'>
          <div class='card-title'>Save Custom Pan</div>
          <div class='card-text'>
            Looks like you are creating a custom coating pan. Save it to reference it again later.
          </div>
          <paper-button class='highlight-button'on-tap=''>Save</paper-button>
        </div>
        
      </div>
      
    </div>
  </template>

  <script>
    class CoatingPanPage extends CoatingDashboard.ReduxMixin(Polymer.Element) {
      
      static get is() { return 'coating-pan-page'; }
      
      static get properties() {
        return {
          // properties from redux mixin
          panDiameter: {
            type: Number,
            statePath: 'pan.panDiameter'
          },
          openingDiameter: {
            type: Number,
            statePath: 'pan.openingDiameter'
          },
          wallWidth: {
            type: Number,
            statePath: 'pan.wallWidth'
          },
          brimWidth: {
            type: Number,
            statePath: 'pan.brimWidth'
          },
          fillVolume: {
            type: Number,
            statePath: 'pan.fillVolume'
          },
          vendorName: {
            type: String,
            statePath: 'pan.vendorName'
          },
          equipmentName: {
            type: String,
            statePath: 'pan.equipmentName'
          },
          nickname: {
            type: String,
            statePath: 'pan.nickname'
          },
          companyName: {
            type: String,
            statePath: 'pan.companyName'
          },
          locationName: {
            type: String,
            statePath: 'pan.locationName'
          },
          brimVolume: {
            type: Number,
            statePath: 'pan.brimVolume'
          },
          minFillVolume: {
            type: Number,
            statePath: 'pan.minFillVolume'
          },
          maxFillVolume: {
            type: Number,
            statePath: 'pan.maxFillVolume'
          },
          fillWidth: {
            type: Number,
            statePath: 'pan.fillWidth'
          },
          fillToBrim: {
            type: Number,
            statePath: 'pan.fillToBrim'
          },
          fillHeight: {
            type: Number,
            statePath: 'pan.fillHeight'
          },
          fillLength: {
            type: Number,
            statePath: 'pan.fillLength'
          },
          maxFillHeight: {
            type: Number,
            statePath: 'pan.maxFillHeight'
          },
          minFillHeight: {
            type: Number,
            statePath: 'pan.minFillHeight'
          },
          brimHeight: {
            type: Number,
            statePath: 'pan.brimHeight'
          },
          sideWallSlope: {
            type: Number,
            statePath: 'pan.sideWallSlope'
          },
          user: {
            type: Object
          },
          lengthUnits: {
            type: String,
            value: 'in'
          },
          volumeUnits: {
            type: String,
            value: 'l'
          }
        };
      }
      
      // static get observers() {
      //   return [
      //     'setBrimVolume(brimHeight, wallWidth, panDiameter, sideWallSlope)',
      //     'setMaxFillVolume(maxFillHeight, wallWidth, panDiameter, sideWallSlope)',
      //     'setMinFillVolume(minFillHeight, wallWidth, panDiameter, sideWallSlope)',
      //     'setFillWidth(fillHeight, sideWallSlope, wallWidth)',
      //     'setFillToBrim(fillHeight, brimHeight)',
      //     'setFillLength(panDiameter, fillHeight)',
      //     'setFillHeight(brimHeight, panDiameter, wallWidth, sideWallSlope, fillVolume)',
      //     'setMaxFillHeight(brimHeight)',
      //     'setMinFillHeight(brimHeight)',
      //     'setBrimHeight(panDiameter, openingDiameter)',
      //     'setSideWallSlope(brimHeight, brimWidth, wallWidth)'
      //   ];
      // }
      
      // Key properties that are shared through redux
      // setBrimHeight(pan, opening) {
      //   let h = (pan - opening) / 2;
      //   this.dispatch({
      //     type: "SET_PAN_BRIM_HEIGHT",
      //     value: h
      //   });
      // }
      // setSideWallSlope(brimHeight, brimWidth, wallWidth) {
      //   // slope = rise / run
      //   // run = the distance on one side
      //   let slope = brimHeight / ((brimWidth - wallWidth) / 2);
      //   this.dispatch({
      //     type: "SET_PAN_SIDE_WALL_SLOPE",
      //     value: slope
      //   });
      // }
      // setBrimVolume(fillHeight, wallWidth, panDiameter, sideWallSlope) {
      //   let vol = this.calcVolume(fillHeight, wallWidth, panDiameter, sideWallSlope);
      //   this.dispatch({
      //     type: "SET_PAN_BRIM_VOLUME",
      //     value: vol
      //   });
      // }
      // setMaxFillHeight(brimHeight) {
      //   let limit = 0.0254;
      //   if(brimHeight < 0.0254 * 4) {
      //     limit = 0.0254 / 2;
      //   }
      //   let h = brimHeight - limit;
      //   this.dispatch({
      //     type: 'SET_PAN_MAX_FILL_HEIGHT',
      //     value: h
      //   });
      // }
      // setMinFillHeight(brimHeight) {
      //   let h = brimHeight * 0.6;
      //   this.dispatch({
      //     type: 'SET_PAN_MIN_FILL_HEIGHT',
      //     value: h
      //   });
      // }
      // setMaxFillVolume(fillHeight, wallWidth, panDiameter, sideWallSlope) {
      //   let vol = this.calcVolume(fillHeight, wallWidth, panDiameter, sideWallSlope);
      //   this.dispatch({
      //     type: "SET_PAN_MAX_FILL_VOLUME",
      //     value: vol
      //   });
      // }
      // setMinFillVolume(fillHeight, wallWidth, panDiameter, sideWallSlope) {
      //   let vol = this.calcVolume(fillHeight, wallWidth, panDiameter, sideWallSlope);
      //   this.dispatch({
      //     type: "SET_PAN_MIN_FILL_VOLUME",
      //     value: vol
      //   });
      // }
      // setFillWidth(fillHeight, sideWallSlope, wallWidth) {
      //   //the "run" or Width that we moved on one side of the pan side wall
      //   let dist = fillHeight / sideWallSlope;
      //   let width = wallWidth + dist + dist;
      //   this.dispatch({
      //     type: "SET_PAN_FILL_WIDTH",
      //     value: width
      //   });
      // }
      // setFillToBrim(fillHeight, brimHeight) {
      //   let dist = (fillHeight < brimHeight) ? brimHeight - fillHeight : 0;
      //   this.dispatch({
      //     type: 'SET_PAN_FILL_TO_BRIM',
      //     value: dist
      //   });
      // }
      // setFillHeight(brimHeight, panDiameter, wallWidth, sideWallSlope, fillVolume) {
      //   //we estimate the heigh that will match our fill volume
      //   let height;
      //   for(let i=0; i<brimHeight; i = i + 0.0001){
      //     let saggita = brimHeight - i;
      //     let volume = this.calcVolume(saggita, wallWidth, panDiameter, sideWallSlope);
      //     if(volume <= fillVolume){
      //       height = saggita;
      //       break;
      //     }
      //   }
      //   this.dispatch({
      //     type: "SET_PAN_FILL_HEIGHT",
      //     value: height
      //   });
      // }
      // setFillLength(panDiameter, fillHeight) {
      //   let length = this.calcChordLength(panDiameter / 2, fillHeight);
      //   this.dispatch({
      //     type: 'SET_PAN_FILL_LENGTH',
      //     value: length
      //   });
      // }
      
      // User input functions
      panDiameterChanged(e){
        this.dispatch({
          type: 'SET_PAN_DIAMETER',
          value: e.detail.value
        });
      }
      openingDiameterChanged(e){
        this.dispatch({
          type: 'SET_PAN_OPENING_DIAMETER',
          value: e.detail.value
        });
      }
      wallWidthChanged(e){
        this.dispatch({
          type: 'SET_PAN_WALL_WIDTH',
          value: e.detail.value
        });
      }
      brimWidthChanged(e){
        this.dispatch({
          type: 'SET_PAN_BRIM_WIDTH',
          value: e.detail.value
        });
      }
      vendorNameChanged(e){
        this.dispatch({
          type: 'SET_PAN_VENDOR_NAME',
          value: e.detail.value
        });
      }
      equipmentNameChanged(e){
        this.dispatch({
          type: 'SET_PAN_EQUIPMENT_NAME',
          value: e.detail.value
        });
      }
      nicknameChanged(e){
        this.dispatch({
          type: 'SET_PAN_NICKNAME',
          value: e.detail.value
        });
      }
      companyNameChanged(e){
        this.dispatch({
          type: 'SET_PAN_COMPANY_NAME',
          value: e.detail.value
        });
      }
      locationNameChanged(e){
        this.dispatch({
          type: 'SET_PAN_LOCATION_NAME',
          value: e.detail.value
        });
      }
      
      // HELPER FUNCTIONS
      // calcVolume(brimHeight, wallWidth, panDiameter, sideWallSlope) {
      //   //two section to get the volume
      //   // 1. main cylinder along the flat pan wall
      //   // 2. two maxsides along the sloped side walls
        
      //   let radius = panDiameter / 2;
        
      //   // at this height determine the width / chord;
      //   let brimLength = this.calcChordLength(radius, brimHeight);
        
      //   //two section to get the volume
      //   // 1. main cylinder along the flat pan wall
      //   // 2. two sides along the sloped side walls
      //   // to get the main cylinder volume we calculate the area of the sphere segment 
      //   // times the width of the pan wall
      //   let center = this.calcSphereSectionArea(radius, brimLength, brimHeight) * wallWidth;
      //   //side wall volume is like a cone
      //   let cone = this.calcSideWallVolume(radius, brimHeight, sideWallSlope);
      //   //to get the total volume we use the center and two cones;
      //   // value is in meters ^3
      //   return center + cone + cone;
      // }
      // calcChordLength(radius, saggita) {
      //   //brim width... the chord length at the brim height
      //   //typically close to the full diameter as the brim height is near the center
      //   //determined from pythogrean therom of a triangle from the brim height chord and radius
      //   return 2 * Math.sqrt(Math.pow(radius, 2) - Math.pow((radius - saggita), 2)); 
      // }
      // calcSphereSectionArea(radius, chord, saggita){
      //   //see link for more details
      //   // http://mathworld.wolfram.com/CircularSegment.html
        
      //   //the total area of a circle with the diameter
      //   let fullCircleArea = Math.PI * Math.pow(radius, 2);
        
      //   //split the width in half making a right angle triangle
      //   //determine the angle using sin (opposite / hypoteneus)
      //   //times two since we need both sides
      //   let centralAngle = 2 * Math.asin((chord / 2) / radius);
        
      //   //the area of the sphere from the central angle
      //   //the central angle divided by 2 x PI in radians is the fraction of the area we need
      //   // central angle is in radians
      //   let sectionArea = centralAngle / (2 * Math.PI) * fullCircleArea;
        
      //   //we determine the area of a the triangle to be removed
      //   // base * height / 2
      //   //base is the width or brimWidth
      //   // height is the radius - brimHeight aka height
      //   let triangleArea = chord * (radius - saggita) / 2;
        
      //   //remove the triangle area leaving the area of the circle segment
      //   return sectionArea - triangleArea;
      // }
      // calcSideWallVolume(radius, height, slope) {
      //   //the volume of the side wall is estimated by using incremental
      //   //distances along the side wall and calculated how the differences in height
        
      //   // create a letiable to hold total volume
      //   let volume = 0;
        
      //   //the number of increments
      //   let inc = 10;
        
      //   // Determine the incremental rise or height
      //   let heightInc = height / inc;
      //   //determine the incremental run or Width change
      //   let depthInc = heightInc / slope;
        
      //   //we use small area section along the slop and add them together
      //   for(let i=0; i < inc; i++) {
      //     //first we correct for the new height along the side wall slope
          
      //     //this is the loss in height along the sloped side wall
      //     let h = heightInc * i;
          
      //     // the new radius after we account for the change in height along the slope
      //     let smallerRadius = radius - h;
          
      //     // the new saggita is also reduced by the change in height
      //     let smallerSaggita = height - h;
          
      //     // next we determine the new chord length created from the smaller circle segment
      //     let smallerChord = this.calcChordLength(smallerRadius, smallerSaggita);
          
      //     //from this we get the segment area 
      //     let smallerArea = this.calcSphereSectionArea(smallerRadius, smallerChord, smallerSaggita);
          
      //     //we turn area into volume by multiplying by our depth increment and
      //     // we add this section to the total volume
      //     volume = volume + smallerArea * depthInc;
      //   }
      //   return volume;
      // }
      isOverfilled(maxFillVolume, fillVolume) {
        return (maxFillVolume < fillVolume);
      }
      saveCoatingPan() {
        if(!this.user) {
          this.$.auth.signInAnonymously();
        }
        this.$.panQuery.ref.push({
          vendorName: this.vendorName,
          equipmentName: this.equipmentName,
          nickname: this.nickname,
          companyName: this.companyName,
          locationName: this.locationName,
          panDiameter: this.panDiameter,
          openingDiameter: this.openingDiameter,
          brimWidth: this.brimWidth,
          wallWidth: this.wallWidth,
          calculatedBrimVolume: this.brimVolume,
          calculatedMaxFillVolume: this.maxFillVolume,
          calculatedMinFillVolume: this.minFillVolume
          
        });
      }
      gotoLibrary() {
        if(!this.user) {
          this.$.auth.signInAnonymously();
        }
        window.location = '#/coating-pan-library';
      }
      
    }

    window.customElements.define(CoatingPanPage.is, CoatingPanPage);
  </script>
</dom-module>
